import{u as Y}from"./useSDK.03c69fb9.js";import{T as I,b as Q,k as eo,p as V,c as Po,C as go,x as fo,F as wo}from"./index.1b83cc3f.js";import{u as z}from"./useToken.2af96b0f.js";import{h as r,p as so}from"./common.b5864f99.js";import{u as U}from"./pool.fb342b47.js";import"./decimal.a2826370.js";import{u as G}from"./useRate.fc450114.js";import{D as N}from"./decimal.765d8738.js";import{m as D}from"./entry.4704f58e.js";function _o(){const{getToken:A}=z(),b=U(),{setPositionPendingFees:T,setPositionTotalPendingFees:L}=b,F=D(()=>b.poolsObj),B=Y(),{getTokenRatePrice:y}=G(),S=async d=>(console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:25 ~ fetchPosFeeAmount ~ params:",d),(await B.clmmSdk.Position.fetchPosFeeAmount(d)).map((p,l)=>({positionId:d[l].positionId,pool:d[l].poolAddress,feeOwedA:p.feeOwedA.toString(),feeOwedB:p.feeOwedB.toString()}))),k=async d=>{const{isReverse:e,tokenAAddress:n,tokenBAddress:p}=F.value[d.pool],l=await A(n),g=await A(p),w=r(d.feeOwedA).div(N.pow(10,l.decimals)).toString(),i=r(d.feeOwedB).div(N.pow(10,g.decimals)).toString(),u=y(n,w,l.decimals),h=y(p,i,g.decimals),v=r(u).add(h);return{positionId:d.positionId,feesAmountUSD:v,feesList:[{tokenInfo:e?g:l,amount:e?i:w,amountUSD:e?h:u},{tokenInfo:e?l:g,amount:e?w:i,amountUSD:e?u:h}]}};return{getPositionFees:async(d,e=!0)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:71 ~ getPositionFees ~ positionList:",d);try{const n=[];let p=r(0);for(let i=0;i<d.length;i++){const u=d[i];n.push({poolAddress:u.pool,positionId:u.pos_object_id,coinTypeA:u.coin_type_a,coinTypeB:u.coin_type_b})}const l=await S(n);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:84 ~ getPositionFees ~ fecthPosFeeParams:",n);const g=[];for(let i=0;i<l.length;i++){const u=await k(l[i]);p=p.add(r(u.feesAmountUSD)),g.push(u)}const w=Object.fromEntries(g.map(i=>[i.positionId,i]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:78 ~ getPositionFees ~ feesObj:",w),T(w),e&&L(p.toString())}catch(n){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:250 ~ getPendingFees ~ error:",n)}}}}function yo(){const A=Y(),{setPositionPendingRewards:b,setPositionTotalPendingRewards:T}=U(),L=U(),F=D(()=>L.poolsObj),{getToken:B}=z(),{getTokenRatePrice:y}=G(),S=async P=>{const d=[];let e=r(0);for(let n=0;n<P.rewarderAmountOwed.length;n++){const p=F.value[P.poolAddress],l=P.rewarderAmountOwed[n];console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:27 ~ warpRewardItem ~ item:",l);const g=await B(l.coin_address),w=r(l.amount_owed.toString()).div(N.pow(10,g.decimals)).toString();console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:29 ~ warpRewardItem ~ amount:",w);const i=y(l.coin_address,w,g.decimals);(p[`rewarder_display${n+1}`]||r(w).gt(0))&&(d.push({tokenInfo:g,amount:w,amountUSD:i}),e=e.add(r(i)))}return{positionId:P.positionId,pool:P.poolAddress,rewarderAmountOwed:d,rewardsAmount:e}};return{getPositionReward:async(P,d=!0)=>{var e;console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:49 ~ getPositionReward ~ positionList:",P);try{const n=[];let p=r(0);for(let i=0;i<P.length;i++){const u=P[i],h=(e=F.value[u.pool])==null?void 0:e.rewarder_infos.map(v=>({coinAddress:v.coinType,...v}));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:63 ~ rewarderInfo ~ poolsObj.value:",F.value),h&&h.length>0&&n.push({poolAddress:u.pool,positionId:u.pos_object_id,coinTypeA:u.coin_type_a,coinTypeB:u.coin_type_b,rewarderInfo:h})}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:70 ~ getPositionReward ~ fetchPosRewardersAmountParams:",JSON.stringify(n));const l=await A.clmmSdk.Rewarder.fetchPosRewardersAmount(n);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:73 ~ getPositionReward ~ rewardsList:",l);const g=[];for(let i=0;i<l.length;i++){const u=await S(l[i]);p=p.add(u.rewardsAmount),g.push(u)}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:64 ~ getPositionReward ~ result:",g);const w=Object.fromEntries(g.map(i=>[i.positionId,i]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:66 ~ getPositionReward ~ rewardsObj:",w),b(w),d&&T(p.toString())}catch(n){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:272 ~ getPendingReward ~ error:",n)}}}}function Ao(){const A=Y(),{getToken:b}=z(),{getTokenRatePrice:T}=G(),{setPositionPendingFarmsRewrds:L}=U(),F=async(y,S)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFarmReward.ts:15 ~ warpFramsReward ~ positionReward:",S);const k=[];let P=r(0);for(let d=0;d<S.length;d++){const e=S[d];if(e.rewarder_amount>0){const n=await b(e.rewarder_type),p=r(e.rewarder_amount).div(N.pow(10,n.decimals)).toString(),l=T(e.rewarder_type,p,n.decimals);l!=="--"&&(P=P.add(l)),k.push({tokenInfo:n,amount:p,amountUSD:l})}}return{positionId:y.pos_object_id,rewardsAmount:P,rewardList:k}};return{getPositionFarmsReward:async y=>{const S=[];y.forEach(e=>{e.position_source=="farms"&&S.push({pool_id:e.farm_pool_id,position_nft_id:e.farm_position_id})});const k=await A.peripherySdk.Farms.calculateFarmingRewards(S);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFarmReward.ts:49 ~ getPositionFarmsReward ~ farmingRewards:",k);const P=[];for(let e=0;e<y.length;e++){const n=y[e];if(n.position_source=="farms"){const p=await F(n,k[n.farm_position_id]);P.push(p)}}const d=Object.fromEntries(P.map(e=>[e.positionId,e]));L(d)}}}function jo(){const A=Y(),{getToken:b}=z(),T=U(),{getPositionFees:L}=_o(),{getPositionReward:F}=yo(),{getPositionFarmsReward:B}=Ao(),{getTokenRatePrice:y}=G(),S=D(()=>T),{setPositionsList:k,setPoolPositionsObj:P,setPositionTotalPrice:d,setIsPositionLoading:e,setPendingYieldLoading:n}=U(),p=D(()=>`${A.clmmSdk.sdkOptions.clmm_pool.package_id}::position::Position`),l=D(()=>`${A.peripherySdk.sdkOptions.frams.package_id}::pool::WrappedPositionNFT`),g=D(()=>S.value.poolsObj),w=t=>{const s=[],m=[];for(const a of t.data){const c=V(a.data.type);if(c.full_address===p.value){const o=fo(a);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:64 ~ buildOwnerPosition ~ position:",o),m.push(o.pool),s.push({...o,position_source:"clmm"})}if(c.full_address===l.value){const o=wo.buildFramsPositionNFT(a);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:66 ~ buildOwnerPosition ~ position:",o),m.push(o.clmm_pool_id),s.push({coin_type_a:o.coinTypeA,coin_type_b:o.coinTypeB,name:o.name,pool:o.clmm_pool_id,tick_lower_index:o.tick_lower_index,tick_upper_index:o.tick_upper_index,position_source:"farms",pos_object_id:o.clmm_position_id,farm_position_id:o.id,liquidity:o.liquidity,farm_pool_id:o.pool_id})}}return{positionList:s,positionPoolIdList:[...new Set(m)]}},i=async t=>{if(t.length===0)return{};try{const s=await A.clmmSdk.Pool.getPools(t),m=[];for(let a=0;a<s.length;a++){const c=s[a];console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:97 ~ getPoolInfoByContract ~ poolInfo:",c);const o=g.value[c.poolAddress].isReverse,_=g.value[c.poolAddress].isFarmingPool,f=await b(c.coinTypeA),R=await b(c.coinTypeB),O=I.sqrtPriceX64ToPrice(new Q(c.current_sqrt_price),f.decimals,R.decimals).toString(),j=r(1).div(r(O)).toString(),q=`${r(c.fee_rate).div(N.pow(10,6)).mul(100).toString()}%`;m.push({...c,coinA:o?R:f,coinB:o?f:R,defaultCoinA:f,defaultCoinB:R,currentPrice:o?j:O,currentPriceReverse:o?O:j,isReverse:o,pool:c.poolAddress,feeRate:q,isFarmingPool:_})}return console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:125 ~ getPoolInfoByContract ~ result:",m),Object.fromEntries(m==null?void 0:m.map(a=>[a==null?void 0:a.poolAddress,a]))}catch(s){return console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:112 ~ getPoolInfoByContract ~ error:",s),{}}},u=async t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:149 ~ getOwnerPositionByRpc ~ getOwnerPositionByRpc:");try{const s=await A.clmmSdk.fullClient.getOwnedObjectsByPage(t,{options:{showType:!0,showContent:!0,showOwner:!0,showDisplay:!0},filter:{MatchAny:[{Package:A.clmmSdk.sdkOptions.clmm_pool.package_id},{StructType:`${Po.Sui.frams.package_id}::pool::WrappedPositionNFT`}]}}),{positionList:m,positionPoolIdList:a}=w(s);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:129 ~ getOwnerPositionByRpc ~ positionPoolIdList:",a);const c=await i(a);return{positionList:m,contractPoolInfoObj:c}}catch{return{positionList:[],contractPoolInfoObj:{}}}},h=t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:71 ~ getCoinAmountFromLiquidity ~ params:",t);const s=I.tickIndexToSqrtPriceX64(t.lowerTick),m=I.tickIndexToSqrtPriceX64(t.upperTick),a=go.getCoinAmountFromLiquidity(new Q(t.liquidity),new Q(t.currentSqrtPrice),s,m,t.roundUp),c=so(a.coinA.toString(),t.defaultCoinA.decimals),o=so(a.coinB.toString(),t.defaultCoinB.decimals);return{coinaAmount:c,coinbAmount:o}},v=async(t,s)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:181 ~ wrapPositionItem ~ positionInfo:",t),console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:140 ~ wrapPositionItem ~ poolInfo:",s);const{current_sqrt_price:m,tickSpacing:a,is_pause:c,isReverse:o,defaultCoinA:_,defaultCoinB:f}=s,R=_.decimals,O=f.decimals,{tick_lower_index:j,tick_upper_index:q,nftHash:So}=t,X=I.sqrtPriceX64ToPrice(m,R,O).toString(),ro=r(1).div(I.sqrtPriceX64ToPrice(m,R,O)).toString(),co=j===eo.getMinIndex(a),ao=q===eo.getMaxIndex(a),C=co?"0":I.tickIndexToPrice(j,R,O).toString(),x=ao?"âˆž":I.tickIndexToPrice(q,R,O).toString(),Z=C=="0"?"0":r(1).div(r(x)).toString(),oo=x=="âˆž"?"âˆž":r(1).div(r(C)).toString(),{coinaAmount:$,coinbAmount:E}=h({lowerTick:j,upperTick:q,currentSqrtPrice:m,roundUp:!1,liquidity:t.liquidity,defaultCoinA:_,defaultCoinB:f}),H=y(_.address,$,_.decimals),W=y(f.address,E,f.decimals);let to;H!=="--"&&W!=="--"&&(to=r(H).add(r(W)).toString());let J,M;if(C==="0"&&x==="âˆž")J="50",M="50";else{const po=r($).mul(X),mo=r(E).add(po);M=r(E).div(mo).mul(100).toFixed(0).toString(),J=r(100).sub(M).toString()}let K;c?K="Closed":x!=="âˆž"&&r(X).gt(x)||r(X).lt(C)?K="Inactive":K="Active";const lo=t.name.split(" | ")[1],uo=t.position_source=="farms"?t.name.split("-")[1]:t.index;return{currentPrice:X,currentPriceReverse:ro,minPrice:o?Z:C,maxPrice:o?oo:x,minPriceResever:o?C:Z,maxPriceResever:o?x:oo,fromPercent:o?M:J,toPercent:o?J:M,positionStatus:K,positionName:lo,currentSqrtPrice:s.current_sqrt_price,currentTickIndex:s.current_tick_index,coinA:o?f:_,coinB:o?_:f,isReverse:o,coinaAmount:o?E:$,coinbAmount:o?$:E,coinaAmountUSD:o?W:H,coinbAmountUSD:o?H:W,positionAmountUSD:to,pool:s.pool,positionSource:t.position_source,positionId:t.pos_object_id,farmsReward:t.farmsReward,feeRate:s.feeRate,nftHash:t.position_source=="farms"?t.farm_position_id:t.pos_object_id,defaultCoinaAddress:V(_.address).full_address,defaultCoinbAddress:V(f.address).full_address,farm_pool_id:t.farm_pool_id,pos_object_id:t.pos_object_id,coin_type_a:t.coin_type_a,coin_type_b:t.coin_type_b,farm_position_id:t.farm_position_id,positionIndex:uo,poolLiquidity:s.liquidity,tickSpacing:s.tickSpacing,current_sqrt_price:s.current_sqrt_price,current_tick_index:s.current_tick_index,tickLowerIndex:j,tickUpperIndex:q}},io=async t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:304 ~ getPositionList ~ getPositionList:"),e(!0),n(!0);const{positionList:s,contractPoolInfoObj:m}=await u(t),a=[];let c=r(0);for(let _=0;_<s.length;_++){const f=s[_],R=await v(f,m[f.pool]);c=c.add(r(R.positionAmountUSD)),a.push(R)}const o=a.sort((_,f)=>f.positionAmountUSD-_.positionAmountUSD);e(!1),k(o),L(s),F(s),B(s),no(o,m),d(c.toString())},no=async(t,s)=>{const a=Object.values(s).reduce((c,o)=>(c[o.pool]={poolInfo:o,positionList:[]},c),{});for(const c of t)a[c.pool]&&a[c.pool].positionList.push(c);P(a)};return{getPositionList:io,getPoolInfoByContract:i,wrapPositionItem:v}}export{yo as a,jo as b,Ao as c,_o as u};
