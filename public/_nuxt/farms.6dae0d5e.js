import{a7 as Y}from"./entry.833e9675.js";import{u as Z,T as D,e as Q,m as V}from"./pool.b1ddb447.js";import{D as m}from"./decimal.0bdeb344.js";import{c as K}from"./sha256.5af084c7.js";const ro=Y("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return Z()}},actions:{async getFarmsPoolList(w){w||(this.farmsPoolListLoading=!0);try{const{data:d}=await fetch(`${K.Sui.api}/v2/sui/swap/count`).then(s=>s.json()),_=d.pools.filter(s=>s.stable_farming);console.log(_,"#farmsPoolsfarmsPools");const f=_.map(s=>{var i,r,o;let U=0;console.log(s,"#farmsPool");const h=s.coin_a.decimals,a=s.coin_b.decimals,c=D.tickIndexToPrice(s.stable_farming.effective_tick_lower,h,a).toString(),l=D.tickIndexToPrice(s.stable_farming.effective_tick_upper,h,a).toString();let n=[];s.rewarder&&s.rewarder.rewarder_coin&&s.rewarder.rewarder_coin.length>0&&(n=(r=(i=s.rewarder)==null?void 0:i.rewarder_coin)==null?void 0:r.map((e,j)=>({...e,amountDay:new m(e.amount_second).mul(new m(60*60*24)).toNumber(),rewarder_display:s.rewarder[`rewarder_display${j+1}`],rewarderApr:e.apr.replace("%","")})));let p=!1;s.stable_farming&&s.stable_farming.stable_rewarder.map(e=>{e.amount_second>0&&(p=!0)});const b=[];s.stable_farming.stable_rewarder.forEach(e=>{U+=Number(e.amount_second),e.amount_second>0&&b.push({emission_per_day:new m(e.amount_second).mul(60*60*24).toDP(2,m.ROUND_HALF_UP),reward_coin:e.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.coin,symbol:e.symbol,allocate_point:Number(e.amount_second)>0?1:0})});const u=s.apr_24h.replace("%",""),t=s.rewarder&&s.rewarder.apr.replace("%","")||0;return console.log(u,t,"rewardApr####"),console.log(U,s,"##totalAllocatePoint"),{...s,clmm_pool_id:s.swap_account,effective_tick_lower:s.stable_farming.effective_tick_lower,effective_tick_upper:s.stable_farming.effective_tick_upper,fee:s.fee*100+"%",id:s.stable_farming.stable_farming_pool,rewarders:b,status:U>0?"Live":"Ended",minPrice:c,maxPrice:l,coinA:s.coin_a,coinB:s.coin_b,stableFarmingApr:s.stable_farming&&s.stable_farming.apr*100,rewarder:{...s.rewarder,rewardList:n},isStableFarming:p,is_display_rewarder:(o=s==null?void 0:s.rewarder)==null?void 0:o.is_display_rewarder,aprTotal:Number(u)+Number(t),apr:s.apr_24h.replace("%",""),clmmApr:Number(u)+Number(t)}});this.farmsPoolList=f,this.farmsPoolObj=Object.fromEntries(f.map(s=>[s.clmm_pool_id,{...s,address:s.clmm_pool_id}])),this.farmsPoolListLoading=!1,console.log(_,f,"farmsPools####")}catch(d){console.log("getFarmsPoolList error:",d);const f=await Q("Sui").getLpList(),s=Object.fromEntries(f.map((c,l)=>[c.address,c]));console.log(s,"cmmLpObj##");const h=await V("Sui").getFramsPoolList();console.log("getFarmsPoolList:",h);const a=h.map(c=>{const l=s[c.clmm_pool_id];let n=0;const{tokensObj:p}=this.getPoolStore,b=c.rewarders.map(o=>{const e=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,j=p[e].decimals,g=p[e].symbol;n=n+Number(o.allocate_point);const S=new m(o.allocate_point).div(new m(o.total_allocate_point));return{...o,reward_coin:e,emission_per_day:Number(o.allocate_point)>0?new m(o.emission_per_second).mul(S).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,j)).toString():"0",symbol:g}}),u=l.coinA.decimals,t=l.coinB.decimals,i=D.tickIndexToPrice(c.effective_tick_lower,u,t).toString(),r=D.tickIndexToPrice(c.effective_tick_upper,u,t).toString();return console.log(n,"allocatePoint##"),{...c,minPrice:i,maxPrice:r,fee:l.fee*100+"%",coinA:l.coinA,coinB:l.coinB,rewarders:b,status:n>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:l.coinA,coin_b:l.coinB}});console.log("getFarmsPoolList",a),this.farmsPoolList=a,this.farmsPoolObj=Object.fromEntries(a.map(c=>[c.clmm_pool_id,{...c,address:c.clmm_pool_id}])),this.cmmPoolInfoObj=s,this.farmsPoolListLoading=!1}},async getPositionByPool(w,d,_){var t,i;this.farmsLoadingObj[d]=!0;const f=Q("Sui"),s=V("Sui");console.log(w,d,"#account, poolAddress");const h=(await s.getOwnedFramsPositionNFTList(!0)).filter(r=>r.clmm_pool_id==d),a=await f.getPositionList(w,{address:{address:d}})||[],c=h.concat(a);console.log(h,a,"###farmingPositionList"),console.log(c,"###positionGroup");const l={},n={},p=[];for(let r=0;r<c.length;r++){const o=c[r],e=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log(e,"##poolInfo");const j=e.coinA.decimals,g=e.coinB.decimals;let S,L;o.tick_lower_index==f.TickUtil.getMinIndex(Number(e.tick_spacing))?S="0":S=f.TickMath.tickIndexToPrice(Number(o.tick_lower_index),j,g).toString(),o.tick_upper_index==f.TickUtil.getMaxIndex(Number(e.tick_spacing))?L="∞":L=f.TickMath.tickIndexToPrice(Number(o.tick_upper_index),j,g).toString(),console.log(o,"#position.clmm_pool_id");let O;const A=await f.getPool(o.clmm_pool_id||o.pool),B=D.sqrtPriceX64ToPrice(A.current_sqrt_price,j,g).toString();Number(B)>=Number(S)&&(L==="∞"||Number(B)<=Number(L))?O="Active":(Number(B)>Number(L)||Number(B)<Number(S))&&(O="Inactive");const k=f.getCoinAmountFromLiquidity({pool:A,position:o,roundUp:!1}),{RATES:N,tokensObj:I}=this.getPoolStore;console.log(N,"##cmmPoolStore");const T=((t=N[e.coin_a.address])==null?void 0:t.price)||"",x=((i=N[e.coin_a.address])==null?void 0:i.price)||"",E=new m(k.coinaAmount).div(Math.pow(10,j)),y=new m(k.coinbAmount).div(Math.pow(10,g)),q=new m(k.coinaAmount).div(Math.pow(10,j)).mul(T),F=new m(k.coinbAmount).div(Math.pow(10,g)).mul(x);let C=new m(0);const v=this.farmsPoolObj[o.clmm_pool_id];console.log("farmsPoolInfo:",v);const R=[];o.rewards&&o.rewards.length>0?(o.rewards.forEach((P,J)=>{var W;const G=P.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":P.rewarder_type,H=I[G],M=((W=N[G])==null?void 0:W.price)||0,X=new m(P.rewarder_amount).div(new m(Math.pow(10,H.decimals))),$=X.mul(new m(M));n[o.clmm_pool_id]&&n[o.clmm_pool_id][o.id]?n[o.clmm_pool_id][o.id]=n[o.clmm_pool_id][o.id].add($):n[o.clmm_pool_id]&&!n[o.clmm_pool_id][o.id]?(n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$):(n[o.clmm_pool_id]={},n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$),console.log(this.farmsRewardObj,"##farmsRewardObj"),C=C.add($),(v.rewarders[J]||P.rewarder_amount>0)&&R.push({...P,rewarderAmount:X.toString(),rewarderAmountUsd:$.toString(),rewarderType:G})}),o.rewards=R):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let z;if(o.id){const P=q.add(F);l[o.clmm_pool_id]||(l[o.clmm_pool_id]={}),l[o.clmm_pool_id][o.id]=P}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),p.push({...o,minPrice:S,maxPrice:L,positionUSD:q.add(F).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:O,positionSource:o.creator?"clmm":"farming",farmsPoolId:_,coinA:e.coinA,coinB:e.coinB,positionShare:z,amountAUsd:q,amountBUsd:F,amountA:E,amountB:y,positionRewardAmount:C})}const b={};Object.keys(n).forEach(r=>{b[r]={},b[r].amountUsd=new m(0),typeof n[r]=="object"&&Object.keys(n[r]).forEach(o=>{console.log(o,n[r][o],"#######375"),b[r].amountUsd=b[r].amountUsd.add(n[r][o])})});const u={};Object.keys(l).forEach(r=>{u[r]={},u[r].amount=new m(0),u[r].positionNum=0,typeof l[r]=="object"&&Object.keys(l[r]).forEach(o=>{u[r].amount=u[r].amount.add(l[r][o]),u[r].positionNum+=1})}),console.log("farmsUserUsd:",l),console.log(b,"##farmsRewardObjResult"),this.farmsRewardObj[d]={},this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd[d]={},this.farmsUserUsd={...this.farmsUserUsd,...u},this.farmsPositionObj[d]=p,this.farmsLoadingObj[d]=!1,this.getMyFarms()},async getPositionByAllPool(w){var b,u;this.farmsAllPositionLoading=!0;const d=V("Sui"),_=Q("Sui"),f=await d.getOwnedFramsPositionNFTList(!0),s=await _.getPositionList(w,this.farmsPoolObj)||[];console.log(s,"###clmmPositionList");const U=f.concat(s);console.log(U,"##positionGroup");const h=[],a={},c={};for(let t=0;t<U.length;t++){const i=U[t],r=await _.getPool(i.clmm_pool_id||i.pool),o=_.getCoinAmountFromLiquidity({pool:r,position:i,roundUp:!1}),{RATES:e,tokensObj:j}=this.getPoolStore,g=this.farmsPoolObj[i.clmm_pool_id||i.pool],S=((b=e[g.coin_a.address])==null?void 0:b.price)||"",L=((u=e[g.coin_b.address])==null?void 0:u.price)||"",O=g.coin_a.decimals,A=g.coin_b.decimals,B=new m(o.coinaAmount).div(Math.pow(10,O)),k=new m(o.coinbAmount).div(Math.pow(10,A)),N=new m(o.coinaAmount).div(Math.pow(10,O)).mul(S),I=new m(o.coinbAmount).div(Math.pow(10,A)).mul(L);let T,x;i.tick_lower_index==_.TickUtil.getMinIndex(Number(g.tick_spacing))?T="0":T=_.TickMath.tickIndexToPrice(Number(i.tick_lower_index),O,A).toString(),i.tick_upper_index==_.TickUtil.getMaxIndex(Number(g.tick_spacing))?x="∞":x=_.TickMath.tickIndexToPrice(Number(i.tick_upper_index),O,A).toString();let E;const y=D.sqrtPriceX64ToPrice(r.current_sqrt_price,O,A).toString();Number(y)>=Number(T)&&(x==="∞"||Number(y)<=Number(x))?E="Active":(Number(y)>Number(x)||Number(y)<Number(T))&&(E="Inactive");let q;if(i.id){const v=N.add(I);c[i.clmm_pool_id]||(c[i.clmm_pool_id]={}),c[i.clmm_pool_id][i.id]=v}let F=new m(0);const C=[];if(i.rewards&&i.rewards.length>0){const v=this.farmsPoolObj[i.clmm_pool_id];console.log("farmsPoolInfo:",v),i.rewards.forEach((R,z)=>{var X;const P=R.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":R.rewarder_type,J=j[P],G=((X=e[P])==null?void 0:X.price)||0,H=new m(R.rewarder_amount).div(new m(Math.pow(10,J.decimals))),M=H.mul(new m(G));a[i.clmm_pool_id]&&a[i.clmm_pool_id][i.id]?a[i.clmm_pool_id][i.id]=a[i.clmm_pool_id][i.id].add(M):a[i.clmm_pool_id]&&!a[i.clmm_pool_id][i.id]?(a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=M):(a[i.clmm_pool_id]={},a[i.clmm_pool_id][i.id]={},a[i.clmm_pool_id][i.id]=M),console.log(this.farmsRewardObj,"##farmsRewardObj"),F=F.add(M),(v.rewarders[z]||R.rewarder_amount>0)&&C.push({...R,rewarderAmount:H.toString(),rewarderAmountUsd:M.toString(),rewarderType:P})}),i.rewards=C}else i.rewards=[],this.farmsRewardObj[i.clmm_pool_id]={};h.push({...i,minPrice:T,maxPrice:x,positionUSD:N.add(I).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:E,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:g.coinA,coinB:g.coinB,soucrce:i.id?"farming":"clmm",positionShare:q,amountAUsd:N.toString(),amountBUsd:I.toString(),amountA:B.toString(),amountB:k.toString(),positionRewardAmount:F})}this.farmsPositionList=h;const l={};h.forEach(t=>{l[t.clmm_pool_id||t.pool]||(l[t.clmm_pool_id||t.pool]=[]),l[t.clmm_pool_id||t.pool].push(t)}),this.farmsPositionObj=l,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(a,"##this.farmsRewardObj");const n={};Object.keys(a).forEach(t=>{console.log(a,t,"farmsRewardObj:"),n[t]={},n[t].amountUsd=new m(0),typeof a[t]=="object"&&Object.keys(a[t]).forEach(i=>{console.log(a[t][i].toString(),"#######375"),n[t].amountUsd=n[t].amountUsd.add(a[t][i]),console.log(n[t].amountUsd.toString(),"result[key].amountUsd.toString()")})});const p={};Object.keys(c).forEach(t=>{p[t]={},p[t].amount=new m(0),p[t].positionNum=0,typeof c[t]=="object"&&Object.keys(c[t]).forEach(i=>{p[t].amount=p[t].amount.add(c[t][i]),p[t].positionNum+=1})}),console.log("farmsUserUsd:",c),this.farmsRewardObj=n,this.farmsUserUsd=p,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const w=[];this.farmsPoolList.forEach(d=>{console.log(this.farmsPositionObj[d.clmm_pool_id],"this.this.farmsPositionObj[##");const _=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(f=>f.positionSource=="farming");console.log(_,"getMyFarmsresult##"),_&&_.length>0&&w.push(d)}),this.myFarmsPoolList=w,console.log(w,"##myFarms")},setFarmsLoadingObj(w){this.farmsLoadingObj[w]=!0},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{ro as u};
