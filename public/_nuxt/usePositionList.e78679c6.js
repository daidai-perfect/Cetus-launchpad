import{u as H}from"./fetchFun.bc39c99c.js";import{T as b,b as G,n as Z,c as ao,C as uo,q as po,y as mo,F as Po}from"./index.eee0c4a2.js";import{u as J}from"./useToken.9eab9e49.js";import{h as s,p as oo}from"./common.22b46d4a.js";import{u as C}from"./pool.b9493042.js";import"./decimal.a2826370.js";import{u as Q}from"./useRate.cc3126c1.js";import{D as E}from"./decimal.765d8738.js";import{m as L}from"./entry.602fc024.js";function go(){const{getToken:A}=J(),S=C(),{setPositionPendingFees:v,setPositionTotalPendingFees:B}=S,T=L(()=>S.poolsObj),R=H(),{getTokenRatePrice:I}=Q(),j=async u=>(console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:25 ~ fetchPosFeeAmount ~ params:",u),(await R.clmmSdk.Position.fetchPosFeeAmount(u)).map((f,a)=>({positionId:u[a].positionId,pool:u[a].poolAddress,feeOwedA:f.feeOwedA.toString(),feeOwedB:f.feeOwedB.toString()}))),D=async u=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:29 ~ warpFeesItem ~ fees:",u),console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:35 ~ warpFeesItem ~ poolsObj:",T);const{isReverse:l,tokenAAddress:p,tokenBAddress:f}=T.value[u.pool],a=await A(p),P=await A(f),e=s(u.feeOwedA).div(E.pow(10,a.decimals)).toString(),c=s(u.feeOwedB).div(E.pow(10,P.decimals)).toString(),y=I(p,e,a.decimals),h=I(f,c,P.decimals);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:40 ~ warpFeesItem ~ feeOwedAmountA B:",y,h);const t=s(y).add(h);return{positionId:u.positionId,feesAmountUSD:t,feesList:[{tokenInfo:l?P:a,amount:l?c:e,amountUSD:l?h:y},{tokenInfo:l?a:P,amount:l?e:c,amountUSD:l?y:h}]}};return{getPositionFees:async u=>{try{const l=[];let p=s(0);for(let e=0;e<u.length;e++){const c=u[e];l.push({poolAddress:c.pool,positionId:c.pos_object_id,coinTypeA:c.coin_type_a,coinTypeB:c.coin_type_b})}const f=await j(l),a=[];for(let e=0;e<f.length;e++){const c=await D(f[e]);p=p.add(s(c.feesAmountUSD)),a.push(c)}const P=Object.fromEntries(a.map(e=>[e.positionId,e]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:78 ~ getPositionFees ~ feesObj:",P),v(P),B(p.toString())}catch(l){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:250 ~ getPendingFees ~ error:",l)}}}}function fo(){const A=H(),{setPositionPendingRewards:S,setPositionTotalPendingRewards:v}=C(),B=C(),T=L(()=>B.poolsObj),{getToken:R}=J(),{getTokenRatePrice:I}=Q(),j=async w=>{const u=[];let l=s(0);for(let p=0;p<w.rewarderAmountOwed.length;p++){const f=T.value[w.poolAddress],a=w.rewarderAmountOwed[p],P=await R(a.coin_address),e=s(a.amount_owed.toString()).div(E.pow(10,P.decimals)).toString(),c=I(a.coin_address,e,P.decimals);(f[`rewarder_display${p+1}`]||s(e).gt(0))&&(u.push({tokenInfo:P,amount:e,amountUSD:c}),l=l.add(s(c)))}return{positionId:w.positionId,pool:w.poolAddress,rewarderAmountOwed:u,positionPendingRewards:l}};return{getPositionReward:async(w,u)=>{try{const l=[];let p=s(0);for(let e=0;e<w.length;e++){const c=w[e];l.push({poolAddress:c.pool,positionId:c.pos_object_id,coinTypeA:c.coin_type_a,coinTypeB:c.coin_type_b,rewarderInfo:u[c.pool].rewarder_infos})}const f=await A.clmmSdk.Rewarder.fetchPosRewardersAmount(l),a=[];for(let e=0;e<f.length;e++){const c=await j(f[e]);p=p.add(c.positionPendingRewards),a.push(c)}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:64 ~ getPositionReward ~ result:",a);const P=Object.fromEntries(a.map(e=>[e.positionId,e]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:66 ~ getPositionReward ~ rewardsObj:",P),S(P),v(p.toString())}catch(l){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:272 ~ getPendingReward ~ error:",l)}}}}function Ro(){const A=H(),{getToken:S}=J(),v=C(),{getPositionFees:B}=go(),{getPositionReward:T}=fo(),{getTokenRatePrice:R}=Q(),I=L(()=>v),{setPositionsList:j,setPoolPositionsObj:D,setTotalLiquidityPrice:w}=C(),u=L(()=>`${A.clmmSdk.sdkOptions.clmm_pool.package_id}::position::Position`),l=L(()=>`${A.peripherySdk.sdkOptions.frams.package_id}::pool::WrappedPositionNFT`),p=L(()=>I.value.poolsObj),f=t=>{const n=[],d=[];for(const i of t.data){const r=po(i.data.type);if(r.full_address===u.value){const o=mo(i);d.push(o.pool),n.push({...o,position_source:"clmm"})}if(r.full_address===l.value){const o=Po.buildFramsPositionNFT(i);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:66 ~ buildOwnerPosition ~ position:",o),d.push(o.clmm_pool_id),n.push({coin_type_a:o.coinTypeA,coin_type_b:o.coinTypeB,name:o.name,pool:o.clmm_pool_id,tick_lower_index:o.tick_lower_index,tick_upper_index:o.tick_upper_index,position_source:"farms",pos_object_id:o.clmm_position_id,farm_position_id:o.id,liquidity:o.liquidity})}}return{positionList:n,positionPoolIdList:[...new Set(d)]}},a=async t=>{if(t.length===0)return{};try{const n=await A.clmmSdk.Pool.getPools(t),d=[];for(let i=0;i<n.length;i++){const r=n[i];console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:97 ~ getPoolInfoByContract ~ poolInfo:",r);const o=p.value[r.poolAddress].isReverse,m=await S(r.coinTypeA),g=await S(r.coinTypeB),_=b.sqrtPriceX64ToPrice(new G(r.current_sqrt_price),m.decimals,g.decimals).toString(),k=s(1).div(s(_)).toString();d.push({...r,coinA:o?g:m,coinB:o?m:g,defaultCoinA:m,defaultCoinB:g,currentPrice:o?k:_,currentPriceReverse:o?_:k,isReverse:o,pool:r.poolAddress})}return Object.fromEntries(d==null?void 0:d.map(i=>[i==null?void 0:i.poolAddress,i]))}catch(n){return console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:112 ~ getPoolInfoByContract ~ error:",n),{}}},P=async t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:149 ~ getOwnerPositionByRpc ~ getOwnerPositionByRpc:");try{const n=await A.clmmSdk.fullClient.getOwnedObjectsByPage(t,{options:{showType:!0,showContent:!0,showOwner:!0,showDisplay:!0},filter:{MatchAny:[{Package:A.clmmSdk.sdkOptions.clmm_pool.package_id},{StructType:`${ao.Sui.frams.package_id}::pool::WrappedPositionNFT`}]}}),{positionList:d,positionPoolIdList:i}=f(n);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:129 ~ getOwnerPositionByRpc ~ positionPoolIdList:",i);const r=await a(i);return{positionList:d,contractPoolInfoObj:r}}catch{return{positionList:[],contractPoolInfoObj:{}}}},e=t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:71 ~ getCoinAmountFromLiquidity ~ params:",t);const n=b.tickIndexToSqrtPriceX64(t.lowerTick),d=b.tickIndexToSqrtPriceX64(t.upperTick),i=uo.getCoinAmountFromLiquidity(new G(t.liquidity),new G(t.currentSqrtPrice),n,d,t.roundUp),r=oo(i.coinA.toString(),t.defaultCoinA.decimals),o=oo(i.coinB.toString(),t.defaultCoinB.decimals);return{coinaAmount:r,coinbAmount:o}},c=async(t,n)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:181 ~ wrapPositionItem ~ positionInfo:",t),console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:140 ~ wrapPositionItem ~ poolInfo:",n);const{current_sqrt_price:d,tickSpacing:i,is_pause:r,isReverse:o,defaultCoinA:m,defaultCoinB:g}=n,_=m.decimals,k=g.decimals,{tick_lower_index:N,tick_upper_index:W}=t,U=b.sqrtPriceX64ToPrice(d,_,k).toString(),to=s(1).div(b.sqrtPriceX64ToPrice(d,_,k)).toString(),eo=N===Z.getMinIndex(i),io=W===Z.getMaxIndex(i),F=eo?"0":b.tickIndexToPrice(N,_,k).toString(),O=io?"âˆž":b.tickIndexToPrice(W,_,k).toString(),V=F=="0"?"0":s(1).div(s(F)).toString(),Y=O=="âˆž"?"âˆž":s(1).div(s(O)).toString(),{coinaAmount:M,coinbAmount:x}=e({lowerTick:N,upperTick:W,currentSqrtPrice:d,roundUp:!1,liquidity:t.liquidity,defaultCoinA:m,defaultCoinB:g}),K=R(m.address,M,m.decimals),z=R(g.address,x,g.decimals),so=s(K).add(s(z)).toString();let X,q;if(F==="0"&&O==="âˆž")X="50",q="50";else{const co=s(M).mul(U),lo=s(x).add(co);q=s(x).div(lo).mul(100).toFixed(0).toString(),X=s(100).sub(q).toString()}let $;r?$="Closed":O!=="âˆž"&&s(U).gt(O)||s(U).lt(F)?$="Inactive":$="Active";const no=t.name.split(" | ")[1],ro=`${s(n.fee_rate).div(E.pow(10,6)).mul(100).toString()}%`;return{currentPrice:U,currentPriceReverse:to,minPrice:o?V:F,maxPrice:o?Y:O,minPriceResever:o?F:V,maxPriceResever:o?O:Y,fromPercent:o?q:X,toPercent:o?X:q,positionStatus:$,positionName:no,currentSqrtPrice:n.current_sqrt_price,currentTickIndex:n.current_tick_index,coinA:o?g:m,coinB:o?m:g,isReverse:o,coinaAmount:o?x:M,coinbAmount:o?M:x,coinaAmountUSD:o?z:K,coinbAmountUSD:o?K:z,positionAmountUSD:so,pool:n.pool,positionSource:t.position_source,positionId:t.pos_object_id,farmPositionId:t.farm_position_id,farmsReward:t.farmsReward,feeRate:ro}},y=async t=>{const{positionList:n,contractPoolInfoObj:d}=await P(t),i=[];let r=s(0);for(let m=0;m<n.length;m++){const g=n[m],_=await c(g,d[g.pool]);r=r.add(s(_.positionAmountUSD)),i.push(_)}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:275 ~ getPositionList ~ list:",i);const o=i.sort((m,g)=>g.positionAmountUSD-m.positionAmountUSD);j(o),B(n),T(n,d),h(o,d),w(r.toString())},h=async(t,n)=>{const i=Object.values(n).reduce((r,o)=>(r[o.pool]={poolInfo:o,positionList:[]},r),{});for(const r of t)i[r.pool]&&i[r.pool].positionList.push(r);D(i),console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:295 ~ getPositionListByPool ~ objs:",i)};return{getPositionList:y,getPoolInfoByContract:a,wrapPositionItem:c}}export{fo as a,Ro as b,go as u};
