import{a7 as H}from"./entry.bbec17f0.js";import{u as J,e as D,m as G,T as E}from"./pool.652e8f54.js";import{D as s}from"./decimal.0bdeb344.js";const W=H("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},totalRwadrdUsd:"",farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return J()}},actions:{async getFarmsPoolList(){this.farmsPoolListLoading=!0;const r=await D("Sui").getLpList(),e=Object.fromEntries(r.map((i,c)=>[i.address,i]));console.log(e,"cmmLpObj##");const O=await G("Sui").getFramsPoolList();console.log("getFarmsPoolList:",O);const A=O.map(i=>{const c=e[i.clmm_pool_id];let f=0;const{tokensObj:N}=this.getPoolStore,n=i.rewarders.map(m=>{const a=m.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":m.reward_coin,P=N[a].decimals;f=f+Number(m.allocate_point);const h=new s(m.allocate_point).div(new s(m.total_allocate_point));return{...m,reward_coin:a,emission_per_day:Number(m.allocate_point)>0?new s(m.emission_per_second).mul(h).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,P)).toString():"0"}}),t=c.coinA.decimals,p=c.coinB.decimals,o=E.tickIndexToPrice(i.effective_tick_lower,t,p).toString(),l=E.tickIndexToPrice(i.effective_tick_upper,t,p).toString();return console.log(f,"allocatePoint##"),{...i,minPrice:o,maxPrice:l,fee:c.fee*100+"%",coinA:c.coinA,coinB:c.coinB,rewarders:n,status:f>0?"Live":"Ended"}});console.log("getFarmsPoolList",A),this.farmsPoolList=A,this.farmsPoolObj=Object.fromEntries(A.map(i=>[i.clmm_pool_id,{...i,address:i.clmm_pool_id}])),this.cmmPoolInfoObj=e,this.farmsPoolListLoading=!1},async getPositionByPool(U,r,e){var n,t;this.farmsLoadingObj[r]=!0;const u=D("Sui"),O=G("Sui");console.log(U,r,"#account, poolAddress");const i=(await O.getOwnedFramsPositionNFTList(!0)).filter(p=>p.clmm_pool_id==r),c=await u.getPositionList(U,{address:{address:r}})||[],f=i.concat(c);console.log(i,c,"###farmingPositionList"),console.log(f,"###positionGroup"),this.farmsUserUsd[r]={amount:new s(0),positionNum:0};const N=[];for(let p=0;p<f.length;p++){const o=f[p],l=this.cmmPoolInfoObj[o.clmm_pool_id||o.pool];console.log(l,"##poolInfo");const m=l.coinA.decimals,a=l.coinB.decimals;let P,h;o.tick_lower_index==u.TickUtil.getMinIndex(Number(l.tick_spacing))?P="0":P=u.TickMath.tickIndexToPrice(Number(o.tick_lower_index),m,a).toString(),o.tick_upper_index==u.TickUtil.getMaxIndex(Number(l.tick_spacing))?h="∞":h=u.TickMath.tickIndexToPrice(Number(o.tick_upper_index),m,a).toString(),console.log(o,"#position.clmm_pool_id");let w;const b=await u.getPool(o.clmm_pool_id||o.pool),M=E.sqrtPriceX64ToPrice(b.current_sqrt_price,m,a).toString();Number(M)>=Number(P)&&(h==="∞"||Number(M)<=Number(h))?w="Active":(Number(M)>Number(h)||Number(M)<Number(P))&&(w="Inactive");const T=u.getCoinAmountFromLiquidity({pool:b,position:o,roundUp:!1}),{RATES:j,tokensObj:v}=this.getPoolStore;console.log(j,"##cmmPoolStore");const I=((n=j[l.coinA.address])==null?void 0:n.price)||"",L=((t=j[l.coinB.address])==null?void 0:t.price)||"",y=new s(T.coinaAmount).div(Math.pow(10,m)),F=new s(T.coinbAmount).div(Math.pow(10,a)),x=new s(T.coinaAmount).div(Math.pow(10,m)).mul(I),R=new s(T.coinbAmount).div(Math.pow(10,a)).mul(L);let _=new s(0);o.rewards&&o.rewards.length>0?o.rewards=o.rewards.map(d=>{var X;console.log(d,o,"reward##171");const B=d.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":d.rewarder_type,q=v[B];console.log(v,"##tokensObj");const k=((X=j[B])==null?void 0:X.price)||0,C=new s(d.rewarder_amount).div(new s(Math.pow(10,q.decimals)));console.log(C,k,"amount,rewardPrice");const S=C.mul(new s(k));console.log(S.toString(),"rewarderAmountUsd");const z=this.farmsRewardObj[o.clmm_pool_id]||{amountUsd:new s(0)};return this.farmsRewardObj[o.clmm_pool_id]?this.farmsRewardObj[o.clmm_pool_id].amountUsd=this.farmsRewardObj[o.clmm_pool_id].amountUsd.add(S):(this.farmsRewardObj[o.clmm_pool_id]=z,this.farmsRewardObj[o.clmm_pool_id].amountUsd=new s(0).add(S)),console.log(this.farmsRewardObj,"##farmsRewardObj"),this.totalRwadrdUsd=new s(this.totalRwadrdUsd).add(S),_=_.add(S),{...d,rewarderAmount:C.toString(),rewarderAmountUsd:S.toString(),rewarderType:B}}):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let g;if(o.id){const d=x.add(R),B=this.farmsUserUsd[o.clmm_pool_id]||{amount:new s(0),positionNum:0};this.farmsUserUsd[o.clmm_pool_id]?(this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(d),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[o.clmm_pool_id]=B,this.farmsUserUsd[o.clmm_pool_id].amount=this.farmsUserUsd[o.clmm_pool_id].amount.add(d),this.farmsUserUsd[o.clmm_pool_id].positionNum+=1),console.log(o,"potision###");const q=this.farmsPoolObj[o.clmm_pool_id];g=O.calculatePositionShare(o,q,b.current_sqrt_price),console.log(g,"##positionShare")}N.push({...o,minPrice:P,maxPrice:h,positionUSD:x.add(R).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:w,positionSource:o.creator?"clmm":"farming",farmsPoolId:e,coinA:l.coinA,coinB:l.coinB,positionShare:g,amountAUsd:x,amountBUsd:R,amountA:y,amountB:F,positionRewardAmount:_})}this.farmsPositionObj[r]=N,this.farmsLoadingObj[r]=!1},async getPositionByAllPool(U){var f,N;this.farmsAllPositionLoading=!0;const r=G("Sui"),e=D("Sui");this.farmsUserUsd={},this.totalRwadrdUsd=0;const u=await r.getOwnedFramsPositionNFTList(!0),O=await e.getPositionList(U,this.farmsPoolObj)||[];console.log(O,"###clmmPositionList");const A=u.concat(O);console.log(A,"##positionGroup");const i=[];for(let n=0;n<A.length;n++){const t=A[n],p=await e.getPool(t.clmm_pool_id||t.pool),o=e.getCoinAmountFromLiquidity({pool:p,position:t,roundUp:!1}),{RATES:l,tokensObj:m}=this.getPoolStore,a=this.cmmPoolInfoObj[t.clmm_pool_id||t.pool],P=((f=l[a.coinA.address])==null?void 0:f.price)||"",h=((N=l[a.coinB.address])==null?void 0:N.price)||"",w=a.coinA.decimals,b=a.coinB.decimals,M=new s(o.coinaAmount).div(Math.pow(10,w)),T=new s(o.coinbAmount).div(Math.pow(10,b)),j=new s(o.coinaAmount).div(Math.pow(10,w)).mul(P),v=new s(o.coinbAmount).div(Math.pow(10,b)).mul(h);let I,L;t.tick_lower_index==e.TickUtil.getMinIndex(Number(a.tick_spacing))?I="0":I=e.TickMath.tickIndexToPrice(Number(t.tick_lower_index),w,b).toString(),t.tick_upper_index==e.TickUtil.getMaxIndex(Number(a.tick_spacing))?L="∞":L=e.TickMath.tickIndexToPrice(Number(t.tick_upper_index),w,b).toString();let y;const F=E.sqrtPriceX64ToPrice(p.current_sqrt_price,w,b).toString();Number(F)>=Number(I)&&(L==="∞"||Number(F)<=Number(L))?y="Active":(Number(F)>Number(L)||Number(F)<Number(I))&&(y="Inactive");let x;if(t.id){const _=j.add(v),g=this.farmsUserUsd[t.clmm_pool_id]||{amount:new s(0),positionNum:0};this.farmsUserUsd[t.clmm_pool_id]?(this.farmsUserUsd[t.clmm_pool_id].amount=this.farmsUserUsd[t.clmm_pool_id].amount.add(_),this.farmsUserUsd[t.clmm_pool_id].positionNum+=1):(this.farmsUserUsd[t.clmm_pool_id]=g,this.farmsUserUsd[t.clmm_pool_id].amount=this.farmsUserUsd[t.clmm_pool_id].amount.add(_),this.farmsUserUsd[t.clmm_pool_id].positionNum+=1),console.log(t,"potision###");const d=this.farmsPoolObj[t.clmm_pool_id];x=r.calculatePositionShare(t,d,p.current_sqrt_price),console.log(x,"##positionShare")}let R=new s(0);t.rewards&&t.rewards.length>0&&(t.rewards=t.rewards.map(_=>{var S;console.log(_,"#reward292");const g=_.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":_.rewarder_type,d=m[g];console.log(d,g,"tokenInfo##294");const B=((S=l[g])==null?void 0:S.price)||0,q=new s(_.rewarder_amount).div(new s(Math.pow(10,d==null?void 0:d.decimals))),k=q.mul(new s(B)),C=this.farmsRewardObj[t.clmm_pool_id]||{amountUsd:new s(0)};return this.farmsRewardObj[t.clmm_pool_id]?this.farmsRewardObj[t.clmm_pool_id].amountUsd=this.farmsRewardObj[t.clmm_pool_id].amountUsd.add(k):(this.farmsRewardObj[t.clmm_pool_id]=C,this.farmsRewardObj[t.clmm_pool_id].amountUsd=new s(0).add(k)),this.totalRwadrdUsd=new s(this.totalRwadrdUsd).add(k),R=R.add(k),{..._,rewarderAmount:q.toString(),rewarderAmountUsd:k.toString(),rewarderType:g}})),i.push({...t,minPrice:I,maxPrice:L,positionUSD:j.add(v).toNumber(),clmmPool:t.clmm_pool_id||t.pool,positionStatus:y,positionSource:t.creator?"clmm":"farming",farmsPoolId:t.id,coinA:a.coinA,coinB:a.coinB,soucrce:t.id?"farming":"clmm",positionShare:x,amountAUsd:j.toString(),amountBUsd:v.toString(),amountA:M.toString(),amountB:T.toString(),positionRewardAmount:R})}this.farmsPositionList=i;const c={};i.forEach(n=>{c[n.clmm_pool_id||n.pool]||(c[n.clmm_pool_id||n.pool]=[]),c[n.clmm_pool_id||n.pool].push(n)}),this.farmsPositionObj=c,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),this.getMyFarms()},getMyFarms(){const U=[];this.farmsPoolList.forEach(r=>{console.log(this.farmsPositionObj[r.clmm_pool_id],"this.this.farmsPositionObj[##");const e=this.farmsPositionObj[r.clmm_pool_id]&&this.farmsPositionObj[r.clmm_pool_id].filter(u=>u.positionSource=="farming");console.log(e,"getMyFarmsresult##"),e&&e.length>0&&U.push(r)}),this.myFarmsPoolList=U,console.log(U,"##myFarms")}}});export{W as u};
