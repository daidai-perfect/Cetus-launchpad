import{a6 as I}from"./entry.d2fe8287.js";import{u as oo,b as V,c as K}from"./pool.b77853f9.js";import{g as so,T as G}from"./index.3377e62e.js";import{D as n}from"./decimal.0bdeb344.js";const ao=I("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return oo()}},actions:{async getFarmsPoolList(h){console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:33 ~ getFarmsPoolList ~ isDefault:",h),h||(this.farmsPoolListLoading=!0);try{const{data:d}=await fetch(`${so.Sui.api}/v2/sui/swap/count/v3`).then(t=>t.json()),_=d.pools.filter(t=>t.stable_farming);console.log(_,"#farmsPoolsfarmsPools");const j=await V("Sui").getSuiTokenObj();console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:43 ~ getFarmsPoolList ~ tokensObj:",j);const v=_.map(t=>{var i,u,w;let O=0;console.log(t,"#farmsPool");const a=j[t.token_a_address].decimals,e=j[t.token_b_address].decimals,c=G.tickIndexToPrice(t.stable_farming.effective_tick_lower,a,e).toString(),r=G.tickIndexToPrice(t.stable_farming.effective_tick_upper,a,e).toString();let g=[];t.rewarder&&t.rewarder.rewarder_coin&&t.rewarder.rewarder_coin.length>0&&(g=(u=(i=t.rewarder)==null?void 0:i.rewarder_coin)==null?void 0:u.map((o,s)=>({...o,amountDay:new n(o.amount_second).mul(new n(60*60*24)).toNumber(),rewarder_display:t.rewarder[`rewarder_display${s+1}`],rewarderApr:o.apr.replace("%","")})));let L=!1;t.stable_farming&&t.stable_farming.stable_rewarder.map(o=>{o.amount_second>0&&(L=!0)});const b=[];t.stable_farming.stable_rewarder.forEach(o=>{O+=Number(o.amount_second),o.amount_second>0&&b.push({emission_per_day:new n(o.amount_second).mul(60*60*24).toDP(2,n.ROUND_HALF_UP),reward_coin:o.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.coin,symbol:o.symbol,allocate_point:Number(o.amount_second)>0?1:0})});const p=t.apr_24h.replace("%",""),S=t.rewarder&&t.rewarder.apr.replace("%","")||0;return console.log(p,S,"rewardApr####"),{...t,clmm_pool_id:t.swap_account,effective_tick_lower:t.stable_farming.effective_tick_lower,effective_tick_upper:t.stable_farming.effective_tick_upper,fee:t.fee*100+"%",id:t.stable_farming.stable_farming_pool,rewarders:b,status:O>0?"Live":"Ended",minPrice:c,maxPrice:r,coinA:{...j[t.token_a_address]},coinB:{...j[t.token_b_address]},stableFarmingApr:t.stable_farming&&t.stable_farming.apr*100,rewarder:{...t.rewarder,rewardList:g},isStableFarming:L,is_display_rewarder:(w=t==null?void 0:t.rewarder)==null?void 0:w.is_display_rewarder,aprTotal:Number(p)+Number(S),apr:t.apr_24h.replace("%",""),clmmApr:Number(p)+Number(S)}});this.farmsPoolList=v,this.farmsPoolObj=Object.fromEntries(v.map(t=>[t.clmm_pool_id,{...t,address:t.clmm_pool_id}])),this.farmsPoolListLoading=!1}catch(d){console.log("getFarmsPoolList error:",d);const _=V("Sui"),f=await _.getLpList();console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:126 ~ getFarmsPoolList ~ cmmLpList:",f);const j=Object.fromEntries(f.map((e,c)=>[e.address,e]));console.log(j,"cmmLpObj##");const t=await K("Sui").getFramsPoolList();console.log("getFarmsPoolList:",t);const O=await _.getSuiTokenObj();console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:137 ~ getFarmsPoolList ~ tokensObj:",O);const a=t==null?void 0:t.map(e=>{const c=j[e.clmm_pool_id];let r=0;const g=e.rewarders.map(i=>{const u=i.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":i.reward_coin,w=O[u].decimals,o=O[u].symbol;r=r+Number(i.allocate_point);const s=new n(i.allocate_point).div(new n(i.total_allocate_point));return{...i,reward_coin:u,emission_per_day:Number(i.allocate_point)>0?new n(i.emission_per_second).mul(s).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,w)).toString():"0",symbol:o}}),L=c.coinA.decimals,b=c.coinB.decimals,p=G.tickIndexToPrice(e.effective_tick_lower,L,b).toString(),S=G.tickIndexToPrice(e.effective_tick_upper,L,b).toString();return console.log(r,"allocatePoint##"),{...e,minPrice:p,maxPrice:S,fee:c.fee*100+"%",coinA:c.coinA,coinB:c.coinB,rewarders:g,status:r>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:c.coinA,coin_b:c.coinB,total_apr:0}});this.farmsPoolList=a,console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:190 ~ getFarmsPoolList ~ list:",a),this.farmsPoolObj=Object.fromEntries(a.map(e=>[e.clmm_pool_id,{...e,address:e.clmm_pool_id}])),this.cmmPoolInfoObj=j,this.farmsPoolListLoading=!1}},async getPositionByPool(h,d,_){var S,i,u,w;this.farmsLoadingObj[d]=!0;const f=V("Sui"),j=await f.getSuiTokenObj(),v=K("Sui");console.log(h,d,"#account, poolAddress");const t=await v.getOwnedFramsPositionNFTList([this.farmsPoolObj[d].id],!0);console.log(t,"###result");const O=t==null?void 0:t.filter(o=>o.clmm_pool_id==d),a=await f.getPositionList(h,{address:{address:d}})||[],e=O.concat(a);console.log(O,a,"###farmingPositionList"),console.log(e,"###positionGroup");const c={},r={},g=[],L=await f.getPool(d);for(let o=0;o<e.length;o++){const s=e[o],l=this.farmsPoolObj[s.clmm_pool_id||s.pool];console.log(l,"##poolInfo");const x=(S=l==null?void 0:l.coinA)==null?void 0:S.decimals,m=(i=l==null?void 0:l.coinB)==null?void 0:i.decimals;let M,F;s.tick_lower_index==f.TickUtil.getMinIndex(Number(l.tick_spacing))?M="0":M=f.TickMath.tickIndexToPrice(Number(s.tick_lower_index),x,m).toString(),s.tick_upper_index==f.TickUtil.getMaxIndex(Number(l.tick_spacing))?F="âˆž":F=f.TickMath.tickIndexToPrice(Number(s.tick_upper_index),x,m).toString(),console.log(s,"#position.clmm_pool_id");let A;const N=G.sqrtPriceX64ToPrice(L.current_sqrt_price,x,m).toString();Number(N)>=Number(M)&&(F==="âˆž"||Number(N)<=Number(F))?A="Active":(Number(N)>Number(F)||Number(N)<Number(M))&&(A="Inactive");const C=f.getCoinAmountFromLiquidity({pool:L,position:s,roundUp:!1}),{RATES:D}=this.getPoolStore;console.log(D,"##cmmPoolStore");const X=((u=D[l==null?void 0:l.token_a_address])==null?void 0:u.price)||0,$=((w=D[l==null?void 0:l.token_b_address])==null?void 0:w.price)||0,E=new n(C.coinaAmount).div(Math.pow(10,x)),T=new n(C.coinbAmount).div(Math.pow(10,m)),R=new n(C.coinaAmount).div(Math.pow(10,x)).mul(X),B=new n(C.coinbAmount).div(Math.pow(10,m)).mul($);let H=new n(0);const q=this.farmsPoolObj[s.clmm_pool_id];console.log("farmsPoolInfo:",q);const z=[];s.rewards&&s.rewards.length>0?(s.rewards.forEach((P,W)=>{var Q;const y=P.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":P.rewarder_type,Y=j[y],Z=((Q=D[y])==null?void 0:Q.price)||0,J=new n(P.rewarder_amount).div(new n(Math.pow(10,Y.decimals))),U=J.mul(new n(Z));r[s.clmm_pool_id]&&r[s.clmm_pool_id][s.id]?r[s.clmm_pool_id][s.id]=r[s.clmm_pool_id][s.id].add(U):r[s.clmm_pool_id]&&!r[s.clmm_pool_id][s.id]?(r[s.clmm_pool_id][s.id]={},r[s.clmm_pool_id][s.id]=U):(r[s.clmm_pool_id]={},r[s.clmm_pool_id][s.id]={},r[s.clmm_pool_id][s.id]=U),console.log(this.farmsRewardObj,"##farmsRewardObj"),H=H.add(U),(q.rewarders[W]||P.rewarder_amount>0)&&z.push({...P,rewarderAmount:J.toString(),rewarderAmountUsd:U.toString(),rewarderType:y})}),s.rewards=z):(s.rewards=[],this.farmsRewardObj[s.clmm_pool_id]={});let k;if(s.id){const P=R.add(B);c[s.clmm_pool_id]||(c[s.clmm_pool_id]={}),c[s.clmm_pool_id][s.id]=P}console.log(this.farmsUserUsd,"##this.farmsUserUsd"),g.push({...s,minPrice:M,maxPrice:F,positionUSD:R.add(B).toNumber(),clmmPool:s.clmm_pool_id||s.pool,positionStatus:A,positionSource:s.creator?"clmm":"farming",farmsPoolId:_,coinA:l.coinA,coinB:l.coinB,positionShare:k,amountAUsd:R,amountBUsd:B,amountA:E,amountB:T,positionRewardAmount:H})}const b={};Object.keys(r).forEach(o=>{b[o]={},b[o].amountUsd=new n(0),typeof r[o]=="object"&&Object.keys(r[o]).forEach(s=>{console.log(s,r[o][s],"#######375"),b[o].amountUsd=b[o].amountUsd.add(r[o][s])})});const p={};Object.keys(c).forEach(o=>{p[o]={},p[o].amount=new n(0),p[o].positionNum=0,typeof c[o]=="object"&&Object.keys(c[o]).forEach(s=>{p[o].amount=p[o].amount.add(c[o][s]),p[o].positionNum+=1})}),console.log("farmsUserUsd:",c),console.log(b,"##farmsRewardObjResult"),this.farmsRewardObj[d]={},this.farmsRewardObj={...this.farmsRewardObj,...b},this.farmsUserUsd[d]={},this.farmsUserUsd={...this.farmsUserUsd,...p},this.farmsPositionObj[d]=g,this.farmsLoadingObj[d]=!1,this.getMyFarms()},async getPositionByAllPool(h){var L,b,p,S;this.farmsAllPositionLoading=!0;const d=K("Sui"),_=V("Sui"),f=await _.getSuiTokenObj(),j=await d.getOwnedFramsPositionNFTList([],!0),v=await _.getPositionList(h,this.farmsPoolObj)||[];console.log(v,"###clmmPositionList");const t=j.concat(v);console.log("ðŸš€ ~ file: farms.ts:393 ~ getPositionByAllPool ~ positionGroup:",t),console.log(t,"##positionGroup");const O=[],a={},e={};if((t==null?void 0:t.length)>0){const i=t.map(w=>w.clmm_pool_id||w.pool),u=await _.getPools(Array.from(new Set(i)));console.log(u,"poolList:");for(let w=0;w<t.length;w++){const o=t[w],s=u.filter(k=>k.poolAddress==o.clmm_pool_id||k.poolAddress==o.pool)[0];console.log(s,u,"##pool");const l=_.getCoinAmountFromLiquidity({pool:s,position:o,roundUp:!1}),{RATES:x}=this.getPoolStore,m=this.farmsPoolObj[o.clmm_pool_id||o.pool];console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:408 ~ getPositionByAllPool ~ poolInfo:",m);const M=((L=x[m==null?void 0:m.token_a_address])==null?void 0:L.price)||0,F=((b=x[m==null?void 0:m.token_b_address])==null?void 0:b.price)||0,A=(p=f[m==null?void 0:m.token_a_address])==null?void 0:p.decimals,N=(S=f[m==null?void 0:m.token_b_address])==null?void 0:S.decimals,C=new n(l.coinaAmount).div(Math.pow(10,A)),D=new n(l.coinbAmount).div(Math.pow(10,N)),X=new n(l.coinaAmount).div(Math.pow(10,A)).mul(M),$=new n(l.coinbAmount).div(Math.pow(10,N)).mul(F);let E,T;o.tick_lower_index==_.TickUtil.getMinIndex(Number(m.tick_spacing))?E="0":E=_.TickMath.tickIndexToPrice(Number(o.tick_lower_index),A,N).toString(),o.tick_upper_index==_.TickUtil.getMaxIndex(Number(m.tick_spacing))?T="âˆž":T=_.TickMath.tickIndexToPrice(Number(o.tick_upper_index),A,N).toString();let R;const B=G.sqrtPriceX64ToPrice(s.current_sqrt_price,A,N).toString();Number(B)>=Number(E)&&(T==="âˆž"||Number(B)<=Number(T))?R="Active":(Number(B)>Number(T)||Number(B)<Number(E))&&(R="Inactive");let H;if(o.id){const k=X.add($);e[o.clmm_pool_id]||(e[o.clmm_pool_id]={}),e[o.clmm_pool_id][o.id]=k}let q=new n(0);const z=[];if(o.rewards&&o.rewards.length>0){const k=this.farmsPoolObj[o.clmm_pool_id];console.log("farmsPoolInfo:",k),o.rewards.forEach((P,W)=>{var Q;const y=P.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":P.rewarder_type,Y=f[y],Z=((Q=x[y])==null?void 0:Q.price)||0,J=new n(P.rewarder_amount).div(new n(Math.pow(10,Y.decimals))),U=J.mul(new n(Z));a[o.clmm_pool_id]&&a[o.clmm_pool_id][o.id]?a[o.clmm_pool_id][o.id]=a[o.clmm_pool_id][o.id].add(U):a[o.clmm_pool_id]&&!a[o.clmm_pool_id][o.id]?(a[o.clmm_pool_id][o.id]={},a[o.clmm_pool_id][o.id]=U):(a[o.clmm_pool_id]={},a[o.clmm_pool_id][o.id]={},a[o.clmm_pool_id][o.id]=U),console.log(this.farmsRewardObj,"##farmsRewardObj"),q=q.add(U),(k.rewarders[W]||P.rewarder_amount>0)&&z.push({...P,rewarderAmount:J.toString(),rewarderAmountUsd:U.toString(),rewarderType:y})}),o.rewards=z}else o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={};O.push({...o,minPrice:E,maxPrice:T,positionUSD:X.add($).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:R,positionSource:o.creator?"clmm":"farming",farmsPoolId:o.pool_id,coinA:m.coinA,coinB:m.coinB,soucrce:o.id?"farming":"clmm",positionShare:H,amountAUsd:X.toString(),amountBUsd:$.toString(),amountA:C.toString(),amountB:D.toString(),positionRewardAmount:q})}}this.farmsPositionList=O;const c={};O.forEach(i=>{c[i.clmm_pool_id||i.pool]||(c[i.clmm_pool_id||i.pool]=[]),c[i.clmm_pool_id||i.pool].push(i)}),this.farmsPositionObj=c,this.farmsAllPositionLoading=!1,console.log(this.farmsPositionObj,"#farmingPositionList"),console.log(a,"##this.farmsRewardObj");const r={};Object.keys(a).forEach(i=>{console.log(a,i,"farmsRewardObj:"),r[i]={},r[i].amountUsd=new n(0),typeof a[i]=="object"&&Object.keys(a[i]).forEach(u=>{console.log(a[i][u].toString(),"#######375"),r[i].amountUsd=r[i].amountUsd.add(a[i][u]),console.log(r[i].amountUsd.toString(),"result[key].amountUsd.toString()")})});const g={};Object.keys(e).forEach(i=>{g[i]={},g[i].amount=new n(0),g[i].positionNum=0,typeof e[i]=="object"&&Object.keys(e[i]).forEach(u=>{g[i].amount=g[i].amount.add(e[i][u]),g[i].positionNum+=1})}),console.log("farmsUserUsd:",e),this.farmsRewardObj=r,this.farmsUserUsd=g,console.log(this.farmsRewardObj,"##this.farmsRewardObj"),this.getMyFarms()},getMyFarms(){const h=[];console.log("ðŸš€ðŸš€ðŸš€ ~ file: farms.ts:588 ~ getMyFarms ~ this.farmsPositionObj:",this.farmsPositionObj),this.farmsPoolList.forEach(d=>{const _=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(f=>f.positionSource=="farming");console.log(_,"getMyFarmsresult##"),_&&_.length>0&&h.push(d)}),this.myFarmsPoolList=h,console.log(h,"##myFarms")},setFarmsLoadingObj(h){this.farmsLoadingObj[h]=!0},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{ao as u};
