import{u as U}from"./pool.c46251c1.js";import{h as a,p as io}from"./common.0baf15f1.js";import{T as I,b as V,k as no,p as Z,c as go,C as fo,x as wo,F as _o}from"./index.3cb79861.js";import"./decimal.a2826370.js";import{u as Y}from"./useRate.4b90fbfa.js";import{u as z}from"./useSDK.dca36967.js";import{u as G}from"./useToken.5352de98.js";import{D as N}from"./decimal.765d8738.js";import{m as D}from"./entry.af131d02.js";function yo(){const S=z(),{getToken:F}=G(),{getTokenRatePrice:T}=Y(),{setPositionPendingFarmsRewrds:O}=U(),b=async(A,R)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFarmReward.ts:15 ~ warpFramsReward ~ positionReward:",R);const k=[];let f=a(0);for(let d=0;d<R.length;d++){const e=R[d];if(e.rewarder_amount>0){const n=await F(e.rewarder_type),P=a(e.rewarder_amount).div(N.pow(10,n.decimals)).toString(),u=T(e.rewarder_type,P,n.decimals);u!=="--"&&(f=f.add(u)),k.push({tokenInfo:n,amount:P,amountUSD:u})}}return{positionId:A.pos_object_id,rewardsAmount:f,rewardList:k}};return{getPositionFarmsReward:async A=>{const R=[];A.forEach(e=>{e.position_source=="farms"&&R.push({pool_id:e.farm_pool_id,position_nft_id:e.farm_position_id})});const k=await S.peripherySdk.Farms.calculateFarmingRewards(R);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFarmReward.ts:49 ~ getPositionFarmsReward ~ farmingRewards:",k);const f=[];for(let e=0;e<A.length;e++){const n=A[e];if(n.position_source=="farms"){const P=await b(n,k[n.farm_position_id]);f.push(P)}}const d=Object.fromEntries(f.map(e=>[e.positionId,e]));O(d)}}}function Ao(){const{getToken:S}=G(),F=U(),{setPositionPendingFees:T,setPositionTotalPendingFees:O}=F,b=D(()=>F.poolsObj),v=z(),{getTokenRatePrice:A}=Y(),R=async d=>(console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:25 ~ fetchPosFeeAmount ~ params:",d),(await v.clmmSdk.Position.fetchPosFeeAmount(d)).map((P,u)=>({positionId:d[u].positionId,pool:d[u].poolAddress,feeOwedA:P.feeOwedA.toString(),feeOwedB:P.feeOwedB.toString()}))),k=async d=>{const{isReverse:e,tokenAAddress:n,tokenBAddress:P}=b.value[d.pool],u=await S(n),w=await S(P),_=a(d.feeOwedA).div(N.pow(10,u.decimals)).toString(),c=a(d.feeOwedB).div(N.pow(10,w.decimals)).toString(),p=A(n,_,u.decimals),h=A(P,c,w.decimals),B=a(p).add(h);return{positionId:d.positionId,feesAmountUSD:B,feesList:[{tokenInfo:e?w:u,amount:e?c:_,amountUSD:e?h:p},{tokenInfo:e?u:w,amount:e?_:c,amountUSD:e?p:h}]}};return{getPositionFees:async(d,e=!0)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:71 ~ getPositionFees ~ positionList:",d);try{const n=[];let P=a(0);for(let c=0;c<d.length;c++){const p=d[c];n.push({poolAddress:p.pool,positionId:p.pos_object_id,coinTypeA:p.coin_type_a,coinTypeB:p.coin_type_b})}const u=await R(n);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:84 ~ getPositionFees ~ fecthPosFeeParams:",n);const w=[];for(let c=0;c<u.length;c++){const p=await k(u[c]);P=P.add(a(p.feesAmountUSD)),w.push(p)}const _=Object.fromEntries(w.map(c=>[c.positionId,c]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionFee.ts:78 ~ getPositionFees ~ feesObj:",_),T(_),e&&O(P.toString())}catch(n){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:250 ~ getPendingFees ~ error:",n)}}}}function So(){const S=z(),{setPositionPendingRewards:F,setPositionTotalPendingRewards:T}=U(),O=U(),b=D(()=>O.poolsObj),{getToken:v}=G(),{getTokenRatePrice:A}=Y(),R=async f=>{const d=[];let e=a(0);for(let n=0;n<f.rewarderAmountOwed.length;n++){const P=b.value[f.poolAddress],u=f.rewarderAmountOwed[n];console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:27 ~ warpRewardItem ~ item:",u);const w=await v(u.coin_address),_=a(u.amount_owed.toString()).div(N.pow(10,w.decimals)).toString();console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:29 ~ warpRewardItem ~ amount:",_);const c=A(u.coin_address,_,w.decimals);(P[`rewarder_display${n+1}`]||a(_).gt(0))&&(d.push({tokenInfo:w,amount:_,amountUSD:c}),e=e.add(a(c)))}return{positionId:f.positionId,pool:f.poolAddress,rewarderAmountOwed:d,rewardsAmount:e}};return{getPositionReward:async(f,d=!0)=>{var e;console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:49 ~ getPositionReward ~ positionList:",f);try{const n=[];let P=a(0);for(let c=0;c<f.length;c++){const p=f[c],h=(e=b.value[p.pool])==null?void 0:e.rewarder_infos.map(B=>({coinAddress:B.coinType,...B}));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:63 ~ rewarderInfo ~ poolsObj.value:",b.value),h&&h.length>0&&n.push({poolAddress:p.pool,positionId:p.pos_object_id,coinTypeA:p.coin_type_a,coinTypeB:p.coin_type_b,rewarderInfo:h})}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:70 ~ getPositionReward ~ fetchPosRewardersAmountParams:",JSON.stringify(n));const u=await S.clmmSdk.Rewarder.fetchPosRewardersAmount(n);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:73 ~ getPositionReward ~ rewardsList:",u);const w=[];for(let c=0;c<u.length;c++){const p=await R(u[c]);P=P.add(p.rewardsAmount),w.push(p)}console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:64 ~ getPositionReward ~ result:",w);const _=Object.fromEntries(w.map(c=>[c.positionId,c]));console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionReward.ts:66 ~ getPositionReward ~ rewardsObj:",_),F(_),d&&T(P.toString())}catch(n){console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:272 ~ getPendingReward ~ error:",n)}}}}function Io(){const S=z(),{getToken:F}=G(),T=U(),{getPositionFees:O}=Ao(),{getPositionReward:b}=So(),{getPositionFarmsReward:v}=yo(),{getTokenRatePrice:A}=Y(),R=D(()=>T),{setLiquidityPositionLoading:k,setPositionsList:f,setPoolPositionsObj:d,setPositionTotalPrice:e,setIsPositionLoading:n,setPendingYieldLoading:P}=U(),u=D(()=>`${S.clmmSdk.sdkOptions.clmm_pool.package_id}::position::Position`),w=D(()=>`${S.peripherySdk.sdkOptions.frams.package_id}::pool::WrappedPositionNFT`),_=D(()=>R.value.poolsObj),c=t=>{const s=[],l=[];for(const r of t.data){const i=Z(r.data.type);if(i.full_address===u.value){const o=wo(r);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:64 ~ buildOwnerPosition ~ position:",o),l.push(o.pool),s.push({...o,position_source:"clmm"})}if(i.full_address===w.value){const o=_o.buildFramsPositionNFT(r);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:66 ~ buildOwnerPosition ~ position:",o),l.push(o.clmm_pool_id),s.push({coin_type_a:o.coinTypeA,coin_type_b:o.coinTypeB,name:o.name,pool:o.clmm_pool_id,tick_lower_index:o.tick_lower_index,tick_upper_index:o.tick_upper_index,position_source:"farms",pos_object_id:o.clmm_position_id,farm_position_id:o.id,liquidity:o.liquidity,farm_pool_id:o.pool_id})}}return{positionList:s,positionPoolIdList:[...new Set(l)]}},p=async t=>{if(t.length===0)return{};try{const s=await S.clmmSdk.Pool.getPools(t),l=[];for(let r=0;r<s.length;r++){const i=s[r];console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:97 ~ getPoolInfoByContract ~ poolInfo:",i);const o=_.value[i.poolAddress].isReverse,g=_.value[i.poolAddress].isFarmingPool,m=await F(i.coinTypeA),y=await F(i.coinTypeB),L=I.sqrtPriceX64ToPrice(new V(i.current_sqrt_price),m.decimals,y.decimals).toString(),j=a(1).div(a(L)).toString(),q=`${a(i.fee_rate).div(N.pow(10,6)).mul(100).toString()}%`;l.push({...i,coinA:o?y:m,coinB:o?m:y,defaultCoinA:m,defaultCoinB:y,currentPrice:o?j:L,currentPriceReverse:o?L:j,isReverse:o,pool:i.poolAddress,feeRate:q,isFarmingPool:g})}return console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:125 ~ getPoolInfoByContract ~ result:",l),Object.fromEntries(l==null?void 0:l.map(r=>[r==null?void 0:r.poolAddress,r]))}catch(s){return console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:112 ~ getPoolInfoByContract ~ error:",s),{}}},h=async t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:149 ~ getOwnerPositionByRpc ~ getOwnerPositionByRpc:");try{const s=await S.clmmSdk.fullClient.getOwnedObjectsByPage(t,{options:{showType:!0,showContent:!0,showOwner:!0,showDisplay:!0},filter:{MatchAny:[{Package:S.clmmSdk.sdkOptions.clmm_pool.package_id},{StructType:`${go.Sui.frams.package_id}::pool::WrappedPositionNFT`}]}}),{positionList:l,positionPoolIdList:r}=c(s);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:129 ~ getOwnerPositionByRpc ~ positionPoolIdList:",r);const i=await p(r);return{positionList:l,contractPoolInfoObj:i}}catch{return{positionList:[],contractPoolInfoObj:{}}}},B=t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:71 ~ getCoinAmountFromLiquidity ~ params:",t);const s=I.tickIndexToSqrtPriceX64(t.lowerTick),l=I.tickIndexToSqrtPriceX64(t.upperTick),r=fo.getCoinAmountFromLiquidity(new V(t.liquidity),new V(t.currentSqrtPrice),s,l,t.roundUp),i=io(r.coinA.toString(),t.defaultCoinA.decimals),o=io(r.coinB.toString(),t.defaultCoinB.decimals);return{coinaAmount:i,coinbAmount:o}},Q=async(t,s)=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:181 ~ wrapPositionItem ~ positionInfo:",t),console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:140 ~ wrapPositionItem ~ poolInfo:",s);const{current_sqrt_price:l,tickSpacing:r,is_pause:i,isReverse:o,defaultCoinA:g,defaultCoinB:m}=s,y=g.decimals,L=m.decimals,{tick_lower_index:j,tick_upper_index:q,nftHash:ko}=t,X=I.sqrtPriceX64ToPrice(l,y,L).toString(),co=a(1).div(I.sqrtPriceX64ToPrice(l,y,L)).toString(),ao=j===no.getMinIndex(r),lo=q===no.getMaxIndex(r),C=ao?"0":I.tickIndexToPrice(j,y,L).toString(),x=lo?"âˆž":I.tickIndexToPrice(q,y,L).toString(),to=C=="0"?"0":a(1).div(a(x)).toString(),eo=x=="âˆž"?"âˆž":a(1).div(a(C)).toString(),{coinaAmount:$,coinbAmount:E}=B({lowerTick:j,upperTick:q,currentSqrtPrice:l,roundUp:!1,liquidity:t.liquidity,defaultCoinA:g,defaultCoinB:m}),H=A(g.address,$,g.decimals),W=A(m.address,E,m.decimals);let so;H!=="--"&&W!=="--"&&(so=a(H).add(a(W)).toString());let J,M;if(C==="0"&&x==="âˆž")J="50",M="50";else{const mo=a($).mul(X),Po=a(E).add(mo);M=a(E).div(Po).mul(100).toFixed(0).toString(),J=a(100).sub(M).toString()}let K;i?K="Closed":x!=="âˆž"&&a(X).gt(x)||a(X).lt(C)?K="Inactive":K="Active";const uo=t.name.split(" | ")[1],po=t.position_source=="farms"?t.name.split("-")[1]:t.index;return{currentPrice:X,currentPriceReverse:co,minPrice:o?to:C,maxPrice:o?eo:x,minPriceResever:o?C:to,maxPriceResever:o?x:eo,fromPercent:o?M:J,toPercent:o?J:M,positionStatus:K,positionName:uo,currentSqrtPrice:s.current_sqrt_price,currentTickIndex:s.current_tick_index,coinA:o?m:g,coinB:o?g:m,isReverse:o,coinaAmount:o?E:$,coinbAmount:o?$:E,coinaAmountUSD:o?W:H,coinbAmountUSD:o?H:W,positionAmountUSD:so,pool:s.pool,positionSource:t.position_source,positionId:t.pos_object_id,farmsReward:t.farmsReward,feeRate:s.feeRate,nftHash:t.position_source=="farms"?t.farm_position_id:t.pos_object_id,defaultCoinaAddress:Z(g.address).full_address,defaultCoinbAddress:Z(m.address).full_address,farm_pool_id:t.farm_pool_id,pos_object_id:t.pos_object_id,coin_type_a:t.coin_type_a,coin_type_b:t.coin_type_b,farm_position_id:t.farm_position_id,positionIndex:po,poolLiquidity:s.liquidity,tickSpacing:s.tickSpacing,current_sqrt_price:s.current_sqrt_price,current_tick_index:s.current_tick_index,tickLowerIndex:j,tickUpperIndex:q,positionLiquidity:t.liquidity}},ro=async t=>{console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:304 ~ getPositionList ~ getPositionList:"),n(!0),P(!0);const{positionList:s,contractPoolInfoObj:l}=await h(t),r=[];let i=a(0);for(let g=0;g<s.length;g++){const m=s[g],y=await Q(m,l[m.pool]);i=i.add(a(y.positionAmountUSD)),r.push(y)}const o=r.sort((g,m)=>m.positionAmountUSD-g.positionAmountUSD);n(!1),f(o),O(s),b(s),v(s),oo(o,l),e(i.toString())},oo=async(t,s)=>{const r=Object.values(s).reduce((i,o)=>(i[o.pool]={poolInfo:o,positionList:[]},i),{});for(const i of t)r[i.pool]&&r[i.pool].positionList.push(i);d(r)};return{getPositionList:ro,getPoolInfoByContract:p,wrapPositionItem:Q,getPositionListByPool:async(t,s)=>{k(!0);const{positionList:l,contractPoolInfoObj:r}=await h(t),i=[];for(let g=0;g<l.length;g++){const m=l[g];if(m.pool===s){const y=await Q(m,r[m.pool]);i.push(y)}}const o=i.sort((g,m)=>m.positionAmountUSD-g.positionAmountUSD);console.log("ðŸš€ðŸš€ðŸš€ ~ file: usePositionList.ts:375 ~ getPositionListByPool ~ sortList:",o),oo(o,r),O(l),b(l),v(l),k(!1)}}}export{Ao as a,So as b,yo as c,Io as u};
