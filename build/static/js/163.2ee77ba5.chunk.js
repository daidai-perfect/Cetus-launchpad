"use strict";(self.webpackChunkbrige_typescript=self.webpackChunkbrige_typescript||[]).push([[163],{8163:(e,t,n)=>{n.r(t),n.d(t,{A:()=>l,S:()=>h,a:()=>i,i:()=>f});var r=n(7718),s=n(9091),a=Object.defineProperty,o=(e,t,n)=>((e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class i{constructor(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];o(this,"transaction"),o(this,"network"),o(this,"chain"),o(this,"description"),o(this,"parallelizable"),this.transaction=e,this.network=t,this.chain=n,this.description=r,this.parallelizable=s}}const c=1002e3,d=1016,p=15240,g={_limit:127,encodingLength:e=>{let t=0;for(;e>=128;t++)e>>=7;return t+1},encode:(e,t,n)=>{if("bigint"==typeof e&&(e=(0,r.df)(e)),e<0)throw new RangeError("value must be unsigned");const s=g.encodingLength(e);if(n=n||0,(t=t||new ArrayBuffer(s)).byteLength<n+s)throw new RangeError("the buffer is too small to encode the number at the offset");const a=new Uint8Array(t,n);let o=0;for(;g._limit<e;)a[o++]=e&g._limit|128,e>>=7;return a[o]=Number(e),a},decode:function(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0,s=0;do{if(t=e[n+s],void 0===t)throw new RangeError("offset out of range");r+=(t&g._limit)<<7*s,s++}while(128<=t);return r}},h={forMessageId:(e,t)=>{const n=(0,r.di)((0,r.db)(e)).publicKey,s=t.emitter.toUniversalAddress().toUint8Array(),a=r.cq.toBytes(BigInt((0,r.a8)(t.chain)),2),o=r.a5.concat(a,s);return h.fromData({appId:e,appAddress:n,idx:t.sequence/BigInt(p),address:o})},forWrappedAsset:(e,t)=>{if((0,r.p)(t.address))throw new Error("native asset cannot be a wrapped asset");const n=(0,r.di)((0,r.db)(e)).publicKey;return h.fromData({appId:e,appAddress:n,idx:BigInt((0,r.a8)(t.chain)),address:t.address.toUniversalAddress().toUint8Array()})},forNativeAsset:(e,t)=>{const n=(0,r.di)((0,r.db)(e)).publicKey;return h.fromData({appId:e,appAddress:n,idx:t,address:r.a5.encode("native")})},forGuardianSet:(e,t)=>{const n=(0,r.di)((0,r.db)(e)).publicKey;return h.fromData({appId:e,appAddress:n,idx:BigInt(t),address:r.a5.encode("guardian")})},forEmitter:(e,t)=>{const n=(0,r.di)((0,r.db)(e)).publicKey;return h.fromData({appId:e,appAddress:n,idx:0n,address:t})},_encode:e=>"bigint"==typeof e?[r.u.encode(g.encode(e))]:[r.u.encode(g.encode(e.length)),r.u.encode(e)],fromData:e=>{const t=["0620010181",...h._encode(e.idx),"4880",...h._encode(e.address),"483110810612443119221244311881",...h._encode(e.appId),"1244312080",...h._encode(e.appAddress),"124431018100124431093203124431153203124422"],n=r.u.decode(t.join(""));return new r.dm(n)},decodeLocalState:async(e,t,n)=>{let s;try{const a=await e.accountApplicationInformation(n,(0,r.df)(t)).do();s=r.dn.from_obj_for_encoding(a).appLocalState}catch{return new Uint8Array}const a=r.N.encode("meta");let o=new Map;for(const c of s.keyValue){if(c.key===a)continue;const e=r.N.decode(c.key)[0],t=r.N.decode(c.value.bytes);o.set(e,t)}const i=[];for(let r=0;r<15;r++)o.has(r)&&i.push(o.get(r));return r.a5.concat(...i)},checkBitsSet:async(e,t,n,s)=>{let a,o=!1;const i=await e.accountInformation(n).do(),c=r.dd.from_obj_for_encoding(i).appsLocalState;if(c&&c.forEach((e=>{BigInt(e.id)===t&&(a=e.keyValue)})),0===(null==a?void 0:a.length))return o;const g=BigInt(p),h=BigInt(8),u=s/g*g,l=(0,r.df)(s-u),f=Math.floor(l/d),m=Math.floor((l-f*d)/8),A=r.N.encode(r.cq.toBytes(f,1));return null==a||a.forEach((e=>{if(e.key!==A);else{const t=r.Z.Buffer.from(e.value.bytes,"base64"),n=1<<(0,r.df)(s%h);o=0!=(t[m]&n)}})),o},storageAccountExists:async(e,t,n)=>{try{const s=await e.accountApplicationInformation(t,(0,r.df)(n)).do();return Object.keys(s).length>0}catch{}return!1}},u=class e{constructor(e,t,n,s){if(o(this,"network"),o(this,"chain"),o(this,"connection"),o(this,"contracts"),o(this,"chainId"),o(this,"coreAppId"),o(this,"coreAppAddress"),o(this,"tokenBridgeAppId"),o(this,"tokenBridgeAppAddress"),this.network=e,this.chain=t,this.connection=n,this.contracts=s,this.chainId=(0,r.a8)(t),!s.coreBridge)throw new Error(`Core contract address for chain ${t} not found`);const a=BigInt(s.coreBridge);if(this.coreAppId=a,this.coreAppAddress=(0,r.db)(a),!s.tokenBridge)throw new Error(`TokenBridge contract address for chain ${t} not found`);const i=BigInt(s.tokenBridge);this.tokenBridgeAppId=i,this.tokenBridgeAppAddress=(0,r.db)(i)}getGuardianSet(e){throw new Error("Method not implemented.")}async*verifyMessage(t,n,s){const a=new r.an(t).toString(),o=await e.submitVAAHeader(this.connection,this.coreAppId,s??this.coreAppId,n,a);for(const e of o.txs)yield this.createUnsignedTx(e,"Core.verifyMessage")}static async fromRpc(t,n){const[r,a]=await s.A.chainFromRpc(t),o=n[a];if(o.network!==r)throw new Error(`Network mismatch: ${o.network} !== ${r}`);return new e(r,a,t,o.contracts)}async*publishMessage(t,n){const s=new r.an(t),a=s.toString(),o=await this.connection.getTransactionParams().do(),i=h.forEmitter(this.coreAppId,s.toUint8Array()),{accounts:c,txs:d}=await e.maybeCreateStorageTx(this.connection,a,this.coreAppId,i,o);for(const e of d)yield this.createUnsignedTx(e,"Core.publishMessage",!0);const p=(0,r.de)({from:a,appIndex:(0,r.df)(this.coreAppId),appArgs:[e.publishMessage,n,r.cq.toBytes(0n,8)],accounts:c,onComplete:r.dg.NoOpOC,suggestedParams:o});yield this.createUnsignedTx({tx:p},"Core.publishMessage",!0)}async getMessageFee(){var t;const n=await this.connection.getApplicationByID((0,r.df)(this.coreAppId)).do(),s=null==(t=r.dp.from_obj_for_encoding(n).params.globalState)?void 0:t.find((t=>t.key===e.feeKey));return s?BigInt(s.value.uint):0n}async getGuardianSetIndex(){throw new Error("Not implemented")}async parseTransaction(e){const t=await this.connection.pendingTransactionInformation(e).do(),n=r.dq.from_obj_for_encoding(t);return this.parseTx(n).map((e=>({chain:e.emitterChain,emitter:e.emitterAddress,sequence:e.sequence})))}async parseMessages(e){const t=await this.connection.pendingTransactionInformation(e).do(),n=r.dq.from_obj_for_encoding(t);return this.parseTx(n)}parseTx(t){const n=[];if(t.innerTxns&&t.innerTxns.length>0&&n.push(...t.innerTxns.flatMap((e=>this.parseTx(e)))),BigInt(t.txn.txn.apid??0)!==this.coreAppId||!t.logs||0===t.logs.length)return n;const s=t.txn.txn.apaa??[];if(3!==s.length||!r.a5.equals(new Uint8Array(s[0]),e.publishMessage))return n;const a=r.cq.decode(t.logs[0]),o=new r.an(t.txn.txn.snd).toUniversalAddress(),i=new Uint8Array(s[1]),c=r.cq.decode(s[2]);return n.push((0,r.cM)("Uint8Array",{emitterChain:this.chain,emitterAddress:o,sequence:a,guardianSet:0,timestamp:0,consistencyLevel:0,nonce:Number(c),payload:i,signatures:[]})),n}static async maybeCreateStorageTx(e,t,n,s,a){const o=(0,r.db)(n),i=s.address(),d=[];if(await h.storageAccountExists(e,i,n))return{accounts:[i],txs:d};a=a??await e.getTransactionParams().do();const p=(0,r.dh)({from:t,to:i,amount:c,suggestedParams:a});p.fee=2*p.fee,d.push({tx:p});const g=(0,r.dr)({from:i,appIndex:(0,r.df)(n),rekeyTo:o,suggestedParams:a});return g.fee=0,d.push({tx:g,signer:{address:s.address(),signTxn:e=>Promise.resolve((0,r.ds)(e,s).blob)}}),{accounts:[i],txs:d}}static async submitVAAHeader(t,n,s,a,o,i){i=i??await t.getTransactionParams().do();let c=[];const d=h.forMessageId(s,{chain:a.emitterChain,sequence:a.sequence,emitter:a.emitterAddress}),{accounts:p,txs:g}=await e.maybeCreateStorageTx(t,o,s,d,i);c.push(...g);const u=h.forGuardianSet(n,a.guardianSet),{accounts:[l],txs:f}=await e.maybeCreateStorageTx(t,o,n,u,i);c.push(...f);let m=[...p,l];const A=await h.decodeLocalState(t,n,l),y=(0,r.cc)(a.hash),b=a.signatures.length,w=Math.ceil(b/e.MAX_SIGS_PER_TXN),I=new r.dm(e.ALGO_VERIFY);for(let h=0;h<w;h++){const t=h*e.MAX_SIGS_PER_TXN,s=a.signatures.slice(t,t+e.MAX_SIGS_PER_TXN),o=20*s.length,d=new Uint8Array(o);for(let e=0;e<s.length;e++){const t=s[e],n=A.slice(20*t.guardianIndex+1,20*(t.guardianIndex+1)+1);d.set(n,20*e)}const p=(0,r.de)({appArgs:[e.verifySigs,r.a5.concat(...s.map((e=>r.a5.concat(new Uint8Array([e.guardianIndex]),e.signature.encode())))),d,y],accounts:m,appIndex:(0,r.df)(n),from:e.ALGO_VERIFY_HASH,onComplete:r.dg.NoOpOC,suggestedParams:i});p.fee=0,c.push({tx:p,signer:{address:I.address(),signTxn:e=>Promise.resolve((0,r.ds)(e,I).blob)}})}const _=(0,r.de)({appArgs:[e.verifyVaa,(0,r.bN)(a)],accounts:m,appIndex:(0,r.df)(n),from:o,onComplete:r.dg.NoOpOC,suggestedParams:i});return _.fee=_.fee*(2+w),c.push({tx:_}),{accounts:m,txs:c}}createUnsignedTx(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return new i(e,this.network,this.chain,t,n)}};o(u,"MAX_SIGS_PER_TXN",6),o(u,"ALGO_VERIFY_HASH","EZATROXX2HISIRZDRGXW4LRQ46Z6IUJYYIHU3PJGP7P5IQDPKVX42N767A"),o(u,"ALGO_VERIFY",new Uint8Array([6,32,4,1,0,32,20,38,1,0,49,32,50,3,18,68,49,1,35,18,68,49,16,129,6,18,68,54,26,1,54,26,3,54,26,2,136,0,3,68,34,67,53,2,53,1,53,0,40,53,240,40,53,241,52,0,21,53,5,35,53,3,35,53,4,52,3,52,5,12,65,0,68,52,1,52,0,52,3,129,65,8,34,88,23,52,0,52,3,34,8,36,88,52,0,52,3,129,33,8,36,88,7,0,53,241,53,240,52,2,52,4,37,88,52,240,52,241,80,2,87,12,20,18,68,52,3,129,66,8,53,3,52,4,37,8,53,4,66,255,180,34,137])),o(u,"feeKey",r.N.encode("MessageFee")),o(u,"verifyVaa",r.a5.encode("verifyVAA")),o(u,"verifySigs",r.a5.encode("verifySigs")),o(u,"publishMessage",r.a5.encode("publishMessage"));let l=u;(0,r.bS)("Algorand","WormholeCore",l);const f=Object.freeze(Object.defineProperty({__proto__:null,AlgorandWormholeCore:l,BITS_PER_BYTE:8,BITS_PER_KEY:d,MAX_BITS:p,MAX_BYTES:1905,MAX_BYTES_PER_KEY:127,MAX_KEYS:15,SEED_AMT:c,StorageLogicSig:h,varint:g},Symbol.toStringTag,{value:"Module"}))}}]);
//# sourceMappingURL=163.2ee77ba5.chunk.js.map